<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BREE-Vending-Machine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; background-color: #f8f9fa; }
    .fly-img { position: absolute; z-index: 9999; transition: all 1s ease-in-out; pointer-events: none; }
    .cart-icon { font-size: 1rem; }
    .fixed-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background-color: #f8f9fa; padding: 0.8rem 1rem; z-index: 1000; border-bottom: 1px solid #dee2e6; }
    .container-fluid { padding-top: 80px !important; }
    .swiper-container { margin-bottom: 0; }
    .swiper-slide { display: flex; justify-content: center; }
    .card { width: 100%; margin: 0; border-radius: 0.5rem; overflow: hidden; position: relative; }
    .card-img-wrapper { height: 140px; display: flex; align-items: center; justify-content: center; background-color: #fff; overflow: hidden; }
    .card-img-top { max-height: 100%; max-width: 100%; object-fit: contain; }
    .card-title { font-size: 0.75rem; line-height: 1.2rem; height: 2.4rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .card-text { font-size: 1.2rem; font-weight: bold; color: red; }
    .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
    .drag-handle { position: absolute; top: 4px; left: 4px; cursor: grab; font-size: 1.2rem; background: #fff; padding: 2px 6px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.3); display: none; }

    /* Toggle Switch CSS */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px; width: 22px;
      left: 3px; bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }

    @media (max-width: 576px) {
      h1 { font-size: 1.4rem; }
      .swiper-slide { width: 160px !important; }
      .card { max-width: 100% !important; }
      .card-title { font-size: 0.8rem; line-height: 1.2rem; height: 2.4rem; }
      .card-text { font-size: 1.1rem; }
      .card-img-wrapper { height: 100px; }
      .btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; }
      .cart-icon { font-size: 0.9rem; }
    }
  </style>
</head>

<body class="bg-light">
  <div class="fixed-header d-flex align-items-center shadow-sm px-3">
    <img src="{{ url_for('static', filename='img/BREE_logo_no_bg.png') }}" alt="BREE Logo" style="height: 30px;">
    <div class="flex-grow-1"></div>
    <div class="d-flex align-items-center gap-2">
      <a href="{{ url_for('cart', vm_id=vm_id) }}" class="btn btn-outline-success position-relative cart-icon" id="cartIcon">
        üõí View Cart
        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ cart_count }}</span>
      </a>
      <div class="d-flex align-items-center gap-2" id="line-profile"></div>
    </div>
  </div>

  <div class="container-fluid px-1">
    <div id="drag-control-wrapper" class="d-flex justify-content-end align-items-center gap-2 mb-2" style="display: none;">
      <div class="d-flex align-items-center gap-1">
        <span style="font-weight: 500;">Edit</span>
        <label class="switch">
          <input type="checkbox" id="toggle-drag">
          <span class="slider"></span>
        </label>
      </div>
      <button id="save-order-btn" class="btn btn-warning btn-sm" style="display: none;">üíæ Save Order</button>
    </div>
    

    <h4 class="mb-2">Best Sellers</h4>
    <div class="swiper mySwiper2 swiper-container">
      <div class="swiper-wrapper">
        {% for product in products[5:] %}
        <div class="swiper-slide">
          <div class="card shadow-sm">
            <div class="card-img-wrapper">
              <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}">
            </div>
            <div class="card-body d-flex flex-column justify-content-between">
              <div>
                <h5 class="card-title">{{ product.name }}</h5>
                <p class="card-text">‡∏ø{{ product.price|int }}</p>
              </div>
              <button class="btn btn-primary add-to-cart mt-2" data-id="{{ product.id }}" data-img="{{ product.image }}">Add to Cart</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <h4 class="mb-2">Products</h4>
    <div class="row g-2" id="product-list">
      {% for product in products %}
      <div class="col-6 col-sm-4 col-md-3 col-lg-2">
        <div class="card shadow-sm h-100 m-0">
          <div class="drag-handle">‚ò∞</div>
          <div class="card-img-wrapper">
            <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}">
          </div>
          <div class="card-body d-flex flex-column justify-content-between">
            <div>
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="card-text">‡∏ø{{ product.price|int }}</p>
            </div>
            <button class="btn btn-primary add-to-cart mt-2" data-id="{{ product.id }}" data-img="{{ product.image }}">Add to Cart</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
const vm_id = "{{ vm_id }}";
const productCountRow2 = {{ products[5:]|length }};
new Swiper(".mySwiper2", {
  loop: productCountRow2 > 5,
  spaceBetween: 4,
  breakpoints: {
    0: { slidesPerView: 2 },
    576: { slidesPerView: 3 },
    768: { slidesPerView: 4 },
    992: { slidesPerView: 5 }
  }
});

async function initLiffFlow() {
  try {
    await liff.init({ liffId: "{{ liff_id }}" });
    if (!liff.isLoggedIn()) {
      const currentPath = window.location.pathname;
      window.location.href = `/liff-login?next=${encodeURIComponent(currentPath)}`;
      return;
    }
    const profile = await liff.getProfile();
    const res = await fetch(`/${vm_id}/profile`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(profile)
    });
    const data = await res.json();
    if (data.point) sessionStorage.setItem('user_point', data.point);
    if (data.is_admin !== undefined) sessionStorage.setItem('is_admin', data.is_admin ? '1' : '0');
    document.getElementById("line-profile").innerHTML = `
      <a href="/${vm_id}/profile" class="position-relative d-inline-block text-decoration-none" style="width: 35px; height: 35px;">
        <img src="${profile.pictureUrl}" alt="Profile"
            style="width: 100%; height: 100%; object-fit: cover; border-radius: 20%; border: 1px solid #ffc107;">
      </a>
    `;
  } catch (err) {
    console.error("LIFF init error:", err);
    document.getElementById("line-profile").innerHTML = "<span class='text-danger'>LIFF error</span>";
  }
}

function setupAddToCartButtons() {
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', async function (e) {
      e.preventDefault();
      const imgSrc = this.getAttribute('data-img');
      const productId = this.getAttribute('data-id');
      const img = document.createElement('img');
      img.src = imgSrc;
      img.className = 'fly-img';
      document.body.appendChild(img);
      const btnRect = this.getBoundingClientRect();
      const cartRect = document.getElementById('cartIcon').getBoundingClientRect();
      img.style.left = (btnRect.left + window.scrollX) + 'px';
      img.style.top = (btnRect.top + window.scrollY) + 'px';
      img.style.width = '100px';
      img.offsetWidth;
      img.style.left = (cartRect.left + window.scrollX) + 'px';
      img.style.top = (cartRect.top + window.scrollY) + 'px';
      img.style.width = '30px';
      img.style.opacity = '0.5';
      setTimeout(() => { img.remove(); }, 800);
      try {
        const res = await fetch(`/${vm_id}/api/add_to_cart`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: parseInt(productId) })
        });
        const data = await res.json();
        if (data.status === 'success') {
          const count = Object.values(data.cart).reduce((a, b) => a + b, 0);
          document.getElementById('cart-count').textContent = count;
        } else {
          alert('Add failed');
        }
      } catch (err) {
        alert('Server error');
      }
    });
  });
}

window.addEventListener("DOMContentLoaded", async () => {
  await initLiffFlow();
  setupAddToCartButtons();

  const isAdmin = sessionStorage.getItem('is_admin') === '1';
  if (isAdmin) {
    const el = document.getElementById('product-list');
    const toggleDrag = document.getElementById('toggle-drag');
    const saveOrderBtn = document.getElementById('save-order-btn');
    const dragHandles = document.querySelectorAll('.drag-handle');
    let sortable = null;
    let originalOrder = Array.from(document.querySelectorAll('#product-list .card')).map(card => {
      return parseInt(card.querySelector('button').getAttribute('data-id'));
    });

    document.getElementById('drag-control-wrapper').style.display = 'flex';

    toggleDrag.addEventListener('change', () => {
      if (toggleDrag.checked) {
        dragHandles.forEach(h => h.style.display = 'block');
        sortable = new Sortable(el, {
          animation: 150,
          ghostClass: 'sortable-ghost',
          handle: '.drag-handle',
          onEnd: function () {
            const currentOrder = Array.from(document.querySelectorAll('#product-list .card')).map(card => {
              return parseInt(card.querySelector('button').getAttribute('data-id'));
            });
            const isChanged = JSON.stringify(currentOrder) !== JSON.stringify(originalOrder);
            saveOrderBtn.style.display = isChanged ? 'block' : 'none';
          }
        });
      } else {
        dragHandles.forEach(h => h.style.display = 'none');
        if (sortable) sortable.destroy();
        sortable = null;
        saveOrderBtn.style.display = 'none';
      }
    });

    saveOrderBtn.addEventListener('click', async () => {
      const newOrder = Array.from(document.querySelectorAll('#product-list .card')).map(card => {
        return parseInt(card.querySelector('button').getAttribute('data-id'));
      });
      try {
        const res = await fetch(`/${vm_id}/api/save_order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ new_order: newOrder })
        });
        const data = await res.json();
        if (data.status === 'success') {
          alert('‚úÖ Order saved successfully');
          originalOrder = newOrder;
          saveOrderBtn.style.display = 'none';
        } else {
          alert('‚ùå Failed to save order');
        }
      } catch (err) {
        console.error('Save order error:', err);
        alert('‚ùå Server error while saving order');
      }
    });
  }
});
</script>
</body>
</html>
