<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LINE Login Redirect</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h4>üîê Logging in with LINE...</h4>
  <script>
    async function initLiff() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const vmId = urlParams.get('vmId') || 'M0001';

        await liff.init({ liffId: "{{ liff_id }}" });

        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
          return;
        }

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ API getFriendship ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
        if (liff.isApiAvailable('getFriendship')) {
          const friendship = await liff.getFriendship();
          if (!friendship.friendFlag) {
            // üü• ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
            window.location.href = "https://line.me/R/oaMessage/@342migue/?addfriend";
            return;
          }
        }

        // üü¢ ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ VM
        window.location.href = `/${vmId}`;

      } catch (err) {
        console.error("LIFF failed:", err);
        document.body.innerHTML = "<h3 style='color:red;'>LIFF failed to initialize. Please check LIFF ID or endpoint.</h3>";
      }
    }

    window.onload = initLiff;
  </script>
</body>
</html>
