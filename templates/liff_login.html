<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LINE Login Redirect</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h4>üîê Logging in with LINE...</h4>
  <script>
    async function initLiff() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const vmId = urlParams.get('vmId') || 'M0001';

        await liff.init({ liffId: "{{ liff_id }}" });

        if (!liff.isLoggedIn()) {
          window.location.href = "https://line.me/R/oaMessage/@342migue/?addfriend";
          liff.login({ redirectUri: window.location.href });
          return;
        }

        // if (liff.isApiAvailable('getFriendship')) {
        //   const friendship = await liff.getFriendship();
        //   if (!friendship.friendFlag) {
        //     window.location.href = "https://line.me/R/oaMessage/@342migue/?addfriend";
        //     return;
        //   }
        // }

        window.location.href = `/${vmId}`;
      } catch (err) {
        console.error("LIFF failed:", err);
        document.body.innerHTML = "<h3 style='color:red;'>xxxxLIFF failed to initialize. Please check LIFF ID or endpoint.</h3>";
      }
    }

    window.onload = initLiff;
  </script>
</body>
</html>
